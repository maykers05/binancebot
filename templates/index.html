<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Deimo Bot Trending</title>
  <link rel="icon" type="image/png" href="/static/favicon.png" />

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="/static/css/style.css" />

  <!-- Chart.js y plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>

  <script>
    Chart.register(window['chartjs-plugin-annotation']);
    Chart.register(window['chartjs-plugin-zoom']);
  </script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    #crypto-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
    }
    .neon-card {
      min-height: 200px;
      padding: 1rem;
    }
    @media (max-width: 1600px) {
      #crypto-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    @media (max-width: 1200px) {
      #crypto-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (max-width: 800px) {
      #crypto-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 500px) {
      #crypto-grid {
        grid-template-columns: 1fr;
      }
    }
    .title-gradient {
      font-size: 2rem;
      font-weight: 900;
      background: linear-gradient(90deg, #3b82f6, #9333ea, #0f172a);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      padding: 4px 16px;
      border-radius: 12px;
      border: 1.5px solid rgba(161, 160, 184, 0.4);
      box-shadow:
        0 0 6px rgba(59, 130, 246, 0.4),
        0 0 7px rgba(147, 51, 234, 0.4);
      text-shadow:
        0 0 15px rgba(255, 255, 255, 0.25);
    }
    #last-update {
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
    }
    .color-bajadas {
      color: #ef4444;
      font-weight: 700;
    }
    .color-subidas {
      color: #22c55e;
      font-weight: 700;
    }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <div class="p-6 w-full mx-auto">
    <div class="flex flex-wrap items-end justify-between gap-4 mb-4 bg-gradient-to-r from-blue-900 via-purple-900 to-black p-3 rounded-xl shadow-lg">
      <h1 class="title-gradient font-bold">Binance Trending</h1>
      <div id="last-update" class="text-sm text-gray-400">√öltima revisi√≥n: ‚Äî</div>
      <div class="flex gap-4 items-end">
        <div class="flex flex-col">
          <label class="text-xs text-cyan-300 mb-1">Intervalo (m√≠nimo 5m)</label>
          <select id="interval" class="bg-gray-800 text-cyan-300 p-2 rounded-lg border border-cyan-500 shadow-inner focus:outline-none focus:ring-2 focus:ring-cyan-400">
            <option>5m</option>
            <option>15m</option>
            <option>30m</option>
            <option>1h</option>
          </select>
        </div>
        <div class="flex flex-col">
          <label class="text-xs text-cyan-300 mb-1">Umbral %</label>
          <input id="umbral" type="number" value="5" class="bg-gray-800 text-cyan-300 p-2 rounded-lg border border-cyan-500 w-20 shadow-inner focus:outline-none focus:ring-2 focus:ring-cyan-400" />
        </div>
      </div>
    </div>

    <div id="crypto-grid"></div>

    <div class="mt-8 bg-gradient-to-br from-gray-800 via-gray-900 to-black p-4 rounded-xl shadow-inner">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-cyan-300 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          Historial de Alertas
        </h2>
        <div class="flex gap-4 items-center">
          <label class="flex items-center gap-1 text-sm text-gray-300">
            <input type="checkbox" id="select-all" class="form-checkbox text-cyan-500 rounded" />
            Seleccionar todo
          </label>
          <button id="delete-selected" class="text-red-400 hover:text-red-600 text-xl" title="Borrar seleccionadas">üóëÔ∏è</button>
          <button id="archive-selected" class="text-yellow-400 hover:text-yellow-600 text-xl" title="Archivar seleccionadas">üì¶</button>
          <button id="open-history" class="text-blue-400 hover:text-blue-600 text-xl" title="Ver historial">üìú</button>
          <button id="open-archiver" class="text-yellow-400 hover:text-yellow-600 text-xl" title="Ver archivador">üóÉÔ∏è</button>
          <button id="open-settings" class="text-cyan-400 hover:text-cyan-600 text-xl" title="Ajustes de par√°metros">‚öôÔ∏è</button>
        </div>
      </div>
      <div class="overflow-auto">
        <table class="w-full text-sm text-white">
          <thead>
            <tr class="text-cyan-400 border-b border-cyan-600">
              <th class="py-2 px-4 text-left">Fecha</th>
              <th class="py-2 px-4 text-left">Cripto</th>
              <th class="py-2 px-2 text-left">Gr√°fico</th>
              <th class="py-2 px-4 text-left">Precio</th>
              <th class="py-2 px-4 text-left">Estado</th>
              <th class="py-2 px-4 text-left">Resultado</th>
              <th class="py-2 px-4 text-left"></th>
            </tr>
          </thead>
          <tbody id="alert-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal ajustes ‚öôÔ∏è -->
  <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
    <div class="bg-gray-900 p-6 rounded-lg shadow-lg text-white w-96">
      <h2 class="text-xl mb-4">‚öôÔ∏è Configuraci√≥n</h2>
      <label class="block mb-2">
        <span class="color-bajadas">üîª BAJADAS</span>: % para alerta ganadora de bajadas:
        <input type="number" id="param-bajada" class="w-full p-1 mt-1 text-black" />
      </label>
      <label class="block mb-2">
        <span class="color-subidas">üìâ SUBIDAS</span>: % de retroceso de entrada para subidas:
        <input type="number" id="param-retroceso-subida" class="w-full p-1 mt-1 text-black" />
      </label>
      <label class="block mb-4">
        <span class="color-subidas">üìà SUBIDAS</span>: % de subida para alerta ganadora:
        <input type="number" id="param-subida" class="w-full p-1 mt-1 text-black" />
      </label>
      <div class="flex justify-end gap-2">
        <button id="close-settings" class="bg-gray-700 px-4 py-2 rounded hover:bg-gray-600">Cancelar</button>
        <button id="save-settings" class="bg-cyan-500 px-4 py-2 rounded hover:bg-cyan-400 text-black font-bold">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal historial üìú -->
  <div id="history-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-gray-900 p-6 rounded-lg shadow-xl max-w-5xl w-full text-white relative">
      <button id="close-history" class="absolute top-2 right-4 text-red-400 hover:text-red-600 text-xl">‚úñÔ∏è</button>
      <h2 class="text-2xl font-bold mb-4">üìú Historial de Alertas</h2>
      <div class="overflow-auto max-h-[70vh] flex flex-col">
        <table class="w-full text-sm text-white border border-gray-700">
          <thead>
            <tr class="bg-gray-800 text-cyan-300">
              <th class="py-2 px-4 text-left">Fecha</th>
              <th class="py-2 px-4 text-left">Cripto</th>
              <th class="py-2 px-2 text-left">Gr√°fico</th>
              <th class="py-2 px-4 text-left">Precio</th>
              <th class="py-2 px-4 text-left">Estado</th>
              <th class="py-2 px-4 text-left">Resultado</th>
            </tr>
          </thead>
          <tbody id="history-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

<!-- Modal archivero üóÉÔ∏è -->
<div id="archiver-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
  <div class="bg-gray-900 p-6 rounded-lg shadow-xl max-w-6xl w-full h-[80vh] overflow-auto relative text-white">
    <button id="close-archiver" class="absolute top-2 right-4 text-red-400 hover:text-red-600 text-xl">‚úñÔ∏è</button>
    <h2 class="text-2xl font-bold mb-4 text-yellow-300">üóÉÔ∏è Archivero de Alertas</h2>

    <!-- Herramientas -->
    <div class="mb-4 flex items-center gap-6">
      <label class="flex items-center gap-2">
        <input type="checkbox" id="archiver-select-all" class="form-checkbox">
        Seleccionar todo
      </label>
      <button id="archiver-restore" class="bg-yellow-500 text-black px-3 py-1 rounded hover:bg-yellow-400">üîÅ Restaurar</button>
      <button id="archiver-delete" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">üóëÔ∏è Eliminar</button>
    </div>

    <div id="archiver-content" class="space-y-4"></div>
  </div>
</div>



  <script>
    Chart.register(window['chartjs-plugin-annotation']);
  </script>

  <script src="/static/js/script.js"></script>

  <script>
  // Mostrar modal del archivero üóÉÔ∏è
  document.getElementById("open-archiver").addEventListener("click", () => {
    document.getElementById("archiver-modal").classList.remove("hidden");
  });

  // Cerrar modal del archivero ‚úñÔ∏è
  document.getElementById("close-archiver").addEventListener("click", () => {
    document.getElementById("archiver-modal").classList.add("hidden");
  });

  // Mostrar solo un mensaje b√°sico para comprobar que üì¶ funciona
  document.getElementById("archive-selected").addEventListener("click", () => {
    alert("Funcionalidad de archivar pendiente.");
  });
</script>

<!-- üîΩ‚ÄÉBLOQUE COMPLETO PARA ARCHIVAR Y MOSTRAR ARCHIVERO üîΩ -->
<script>
/* ===== UTILIDADES ===== */
const LS_KEY_ARCHIVO = "alertasArchivadas";

/* Agrupa por mes‚ÄØ‚Üí‚ÄØd√≠a */
function pushToArchive(alerta) {
  const data = JSON.parse(localStorage.getItem(LS_KEY_ARCHIVO) || "{}");
  const fecha = new Date(alerta.timestamp);
  const mes  = fecha.toLocaleString("default", { month: "long", year: "numeric" });   // p.e. ‚Äúenero¬†2025‚Äù
  const dia  = alerta.timestamp.slice(0, 10);                                          // ‚ÄúYYYY‚ÄëMM‚ÄëDD‚Äù

  if (!data[mes])        data[mes]        = {};
  if (!data[mes][dia])   data[mes][dia]   = [];
  data[mes][dia].push(alerta);

  localStorage.setItem(LS_KEY_ARCHIVO, JSON.stringify(data));
}

/* Renderiza el modal */
function pintarArchivero() {
  const cont = document.getElementById("archiver-content");
  const data = JSON.parse(localStorage.getItem(LS_KEY_ARCHIVO) || "{}");
  cont.innerHTML = "";                       // limpia

  Object.entries(data).forEach(([mes, dias]) => {
    const mesEl = document.createElement("details");
    mesEl.innerHTML = `
      <summary class="cursor-pointer text-lg font-bold text-yellow-400">${mes}</summary>
      <div class="ml-6 space-y-2">
        ${Object.entries(dias).map(([dia, arr]) => `
          <details>
            <summary class="text-cyan-300 cursor-pointer">${dia}</summary>
            <ul class="ml-4 list-disc text-sm space-y-1">
${arr.map(a => `
  <li>
    <span class="text-cyan-400 font-semibold">${a.symbol}</span>
    ‚Äî $${a.price.toFixed(4)}
    ‚Äî <span class="${a.estado === 'SUBIDA' ? 'text-green-400' : 'text-red-400'}">${a.estado}</span>
    ‚Äî ${a.resultado}
    <br>
    <span class="text-gray-400 text-xs">üïí ${a.timestamp}</span>
  </li>`).join("")}

            </ul>
          </details>
        `).join("")}
      </div>`;
    cont.appendChild(mesEl);
  });
}

/* ===== ACCI√ìN üì¶ ARCHIVAR ===== */
function archivarSeleccionadas() {
  const filas = [...document.querySelectorAll(".select-alert:checked")];
  if (!filas.length) { alert("No hay alertas seleccionadas."); return; }

  filas.forEach(cb => {
    const tr = cb.closest("tr");
    const alerta = {
      symbol:    tr.dataset.symbol,
      timestamp: tr.dataset.fecha,
      estado:    tr.dataset.estado,
      price:     parseFloat(tr.dataset.precio),
      entrada:   parseFloat(tr.dataset.entrada),
      objetivo:  parseFloat(tr.dataset.objetivo),
      resultado: tr.querySelector("[data-resultado]")?.innerText.trim() || "ESPERANDO"
    };
    pushToArchive(alerta);      // guarda en localStorage
    tr.remove();                // quita la fila de la tabla principal
  });

  // Limpia el checkbox maestro
  const master = document.getElementById("select-all");
  if (master) master.checked = false;

  alert("‚úÖ¬†Alertas archivadas.");
}

/* ===== LISTENERS ===== */
document.getElementById("archive-selected")
        .addEventListener("click", () => {
          archivarSeleccionadas();
          pintarArchivero();                           // refresca contenido
        });

document.getElementById("open-archiver")
        .addEventListener("click", () => {
          pintarArchivero();
          document.getElementById("archiver-modal").classList.remove("hidden");
        });

document.getElementById("close-archiver")
        .addEventListener("click", () => {
          document.getElementById("archiver-modal").classList.add("hidden");
        });
</script>
<!-- üîº‚ÄÉFIN DEL BLOQUE üîº -->

<script>


/* Agrupa por mes y d√≠a */
function pushToArchive(alerta) {
  const data = JSON.parse(localStorage.getItem(LS_KEY_ARCHIVO) || "{}");
  const fecha = new Date(alerta.timestamp);
  const mes  = fecha.toLocaleString("default", { month: "long", year: "numeric" });
  const dia  = alerta.timestamp.slice(0, 10);

  if (!data[mes]) data[mes] = {};
  if (!data[mes][dia]) data[mes][dia] = [];
  data[mes][dia].push(alerta);

  localStorage.setItem(LS_KEY_ARCHIVO, JSON.stringify(data));
}

function pintarArchivero() {
  const cont = document.getElementById("archiver-content");
  const data = JSON.parse(localStorage.getItem("alertasArchivadas") || "{}");
  cont.innerHTML = "";

  Object.entries(data).forEach(([mes, dias]) => {
    const mesEl = document.createElement("details");
    mesEl.innerHTML = `
      <summary class="cursor-pointer text-lg font-bold text-yellow-400">${mes}</summary>
      <div class="ml-6 space-y-2">
        ${Object.entries(dias).map(([dia, arr]) => `
          <details>
            <summary class="text-cyan-300 cursor-pointer">${dia}</summary>
            <ul class="ml-4 list-disc text-sm space-y-1">
              ${arr.map((a, i) => {
                const colorEstado = a.estado === "SUBIDA" ? "text-green-400" : "text-red-400";

                let colorResultado = "text-gray-300";
                if (a.resultado === "GANADORA") colorResultado = "text-green-400";
                else if (a.resultado === "PARCIALMENTE PERDEDORA") colorResultado = "text-red-400";
                else if (a.resultado === "PARCIALMENTE GANADORA") colorResultado = "text-green-200";

                return `
                  <li>
                    <label class="flex items-start gap-2">
                      <input type="checkbox" class="archiver-checkbox mt-1" data-mes="${mes}" data-dia="${dia}" data-index="${i}">
                      <div>
                        <span class="text-cyan-400 font-semibold">${a.symbol}</span>
                        ‚Äî $${a.price.toFixed(4)}
                        ‚Äî <span class="${colorEstado}">${a.estado}</span>
                        ‚Äî <span class="${colorResultado}">${a.resultado}</span>
                        <br>
                        <span class="text-gray-400 text-xs">üïí ${a.timestamp}</span>
                      </div>
                    </label>
                  </li>`;
              }).join("")}
            </ul>
          </details>
        `).join("")}
      </div>`;
    cont.appendChild(mesEl);
  });
}

function archivarSeleccionadas() {
  const filas = [...document.querySelectorAll(".select-alert:checked")];
  if (!filas.length) return alert("No hay alertas seleccionadas.");

  filas.forEach(cb => {
    const tr = cb.closest("tr");
    const alerta = {
      symbol:    tr.dataset.symbol,
      timestamp: tr.dataset.fecha,
      estado:    tr.dataset.estado,
      price:     parseFloat(tr.dataset.precio),
      entrada:   parseFloat(tr.dataset.entrada),
      objetivo:  parseFloat(tr.dataset.objetivo),
      resultado: tr.querySelector("[data-resultado]")?.innerText.trim() || "ESPERANDO"
    };
    pushToArchive(alerta);
    tr.remove();
  });

  document.getElementById("select-all").checked = false;
  alert("‚úÖ Alertas archivadas.");
}

function eliminarArchivadas() {
  if (!confirm("¬øEst√°s seguro de eliminar las alertas seleccionadas del archivero?")) return;

  const checks = [...document.querySelectorAll(".archived-checkbox:checked")];
  if (!checks.length) return alert("No hay alertas seleccionadas.");
  const data = JSON.parse(localStorage.getItem(LS_KEY_ARCHIVO) || "{}");

  checks.forEach(cb => {
    const timestamp = cb.dataset.timestamp;
    const symbol = cb.dataset.symbol;

    for (const mes in data) {
      for (const dia in data[mes]) {
        data[mes][dia] = data[mes][dia].filter(a => !(a.timestamp === timestamp && a.symbol === symbol));
        if (data[mes][dia].length === 0) delete data[mes][dia];
      }
      if (Object.keys(data[mes]).length === 0) delete data[mes];
    }
  });

  localStorage.setItem(LS_KEY_ARCHIVO, JSON.stringify(data));
  pintarArchivero();
}

function restaurarArchivadas() {
  if (!confirm("¬øEst√°s seguro de restaurar las alertas seleccionadas al historial?")) return;

  const checks = [...document.querySelectorAll(".archived-checkbox:checked")];
  if (!checks.length) return alert("No hay alertas seleccionadas.");
  const data = JSON.parse(localStorage.getItem(LS_KEY_ARCHIVO) || "{}");

  const restauradas = [];

  checks.forEach(cb => {
    const timestamp = cb.dataset.timestamp;
    const symbol = cb.dataset.symbol;

    for (const mes in data) {
      for (const dia in data[mes]) {
        const idx = data[mes][dia].findIndex(a => a.timestamp === timestamp && a.symbol === symbol);
        if (idx !== -1) {
          const [alerta] = data[mes][dia].splice(idx, 1);
          restauradas.push(alerta);
        }
        if (data[mes][dia].length === 0) delete data[mes][dia];
      }
      if (Object.keys(data[mes]).length === 0) delete data[mes];
    }
  });

  localStorage.setItem(LS_KEY_ARCHIVO, JSON.stringify(data));
  pintarArchivero();

  restauradas.forEach(alerta => {
    console.log("üîÅ Restaurada:", alerta);
  });
}

function toggleArchiverSelectAll() {
  const master = document.getElementById("archiver-select-all");
  const checks = document.querySelectorAll(".archived-checkbox");
  checks.forEach(cb => cb.checked = master.checked);
}

function pintarArchivero() {
  const cont = document.getElementById("archiver-content");
  const data = JSON.parse(localStorage.getItem(LS_KEY_ARCHIVO) || "{}");
  cont.innerHTML = "";

  Object.entries(data).forEach(([mes, dias]) => {
    const mesEl = document.createElement("details");
    mesEl.innerHTML = `
      <summary class="cursor-pointer text-lg font-bold text-yellow-400">${mes}</summary>
      <div class="ml-6 space-y-2">
        ${Object.entries(dias).map(([dia, arr]) => `
          <details>
            <summary class="text-cyan-300 cursor-pointer">${dia}</summary>
            <ul class="ml-4 list-disc text-sm space-y-1">
              ${arr.map((a, i) => {
                let color = "";
                if (a.resultado === "GANADORA") color = "text-green-400";
                else if (a.resultado === "PARCIALMENTE PERDEDORA") color = "text-red-400";
                else if (a.resultado === "PARCIALMENTE GANADORA") color = "text-green-200";

                return `
                <li>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="archived-checkbox" data-symbol="${a.symbol}" data-timestamp="${a.timestamp}">
                    <span>
                      <span class="text-cyan-400 font-semibold">${a.symbol}</span>
                      ‚Äî $${a.price.toFixed(4)}
                      ‚Äî <span class="${a.estado === 'SUBIDA' ? 'text-green-400' : 'text-red-400'}">${a.estado}</span>
                      ‚Äî <span class="${color}">${a.resultado}</span>
                      <br>
                      <span class="text-gray-400 text-xs">üïí ${a.timestamp}</span>
                    </span>
                  </label>
                </li>`;
              }).join("")}
            </ul>
          </details>
        `).join("")}
      </div>`;
    cont.appendChild(mesEl);
  });
}

/* Eventos */
document.getElementById("archive-selected").addEventListener("click", () => {
  archivarSeleccionadas();
  pintarArchivero();
});
document.getElementById("open-archiver").addEventListener("click", () => {
  pintarArchivero();
  document.getElementById("archiver-modal").classList.remove("hidden");
});
document.getElementById("close-archiver").addEventListener("click", () => {
  document.getElementById("archiver-modal").classList.add("hidden");
});
document.getElementById("archiver-restore").addEventListener("click", restaurarArchivadas);
document.getElementById("archiver-delete").addEventListener("click", eliminarArchivadas);
document.getElementById("archiver-select-all").addEventListener("change", toggleArchiverSelectAll);
</script>

</body>
</html>
